\chapter{Kode Program Sistem Kini}
\label{app:A}

%selalu gunakan single spacing untuk source code !!!!!
\singlespacing 
% language: bahasa dari kode program
% terdapat beberapa pilihan : Java, C, C++, PHP, Matlab, R, dll
%
% basicstyle : ukuran font untuk kode program
% terdapat beberapa pilihan : tiny, scriptsize, footnotesize, dll
%
% caption : nama yang akan ditampilkan di dokumen akhir, lihat contoh
\begin{lstlisting}[language=PHP,basicstyle=\tiny,caption=handle.php,label={lst:handle.php}]
<?php
require_once '../../etc/utils.php';
require_once '../../etc/constants.php';
require_once '../../etc/PasswordHash.php';

start_working();

$mode = retrieve_from_post($proto_mode);

// Initializes MySQL and check for session
init_mysql();
if ($mode != $proto_mode_login && $mode != $proto_mode_logout && $mode != $proto_mode_register) {
	$sessionid = addslashes(retrieve_from_post($proto_sessionid));
	// Clear expired sessions
	mysqli_query($global_mysqli_link, "DELETE FROM sessions WHERE lastSeen < (NOW() - INTERVAL $session_expiry_interval_mysql)") or
		die_nice('Failed to clean expired sessions: ' . mysqli_error($global_mysqli_link), true);
	$result = mysqli_query($global_mysqli_link, "SELECT users.email, users.privilegeRoute, users.privilegeApiUsage FROM users LEFT JOIN sessions ON users.email = sessions.email WHERE sessions.sessionId = '$sessionid'") or
		die_nice('Failed to get user session information: ' . mysqli_error($global_mysqli_link), true);
	if (mysqli_num_rows($result) == 0) {
		deinit_mysql();
		// Construct json - session expired.
		$json = array(
			$proto_status => $proto_status_sessionexpired,
		);
		print(json_encode($json));
		exit(0);
	}
	$columns = mysqli_fetch_row($result);
	$active_userid = $columns[0]; 
	$privilege_route = $columns[1] != '0';
	$privilege_apiUsage = $columns[2] != '0';
}

if ($mode == $proto_mode_login) {
	$userid = addslashes(retrieve_from_post($proto_userid));
	$plain_password = addslashes(retrieve_from_post($proto_password));
	if (strlen($userid) > $maximum_userid_length) {
		return_invalid_credentials("User ID length is more than allowed (". strlen($userid) . ')');
	}
	if (strlen($plain_password) > $maximum_password_length) {
		return_invalid_credentials('Password length is more than allowed ('. strlen($password) . ')');
	}

	// Retrieve the user information
	$result = mysqli_query($global_mysqli_link, "SELECT * FROM users WHERE email='$userid'") or
		die_nice('Failed to verify user id: ' . mysqli_error($global_mysqli_link), true);
	if (mysqli_num_rows($result) == 0) {
		deinit_mysql();
		return_invalid_credentials("User id not found: $userid");
	}
	$userdata = mysqli_fetch_assoc($result);
	
	// Check against the stored hash.
	$hasher = new PasswordHash($passwordhash_cost_log2, $passwordhash_portable);
	if (!$hasher->CheckPassword($plain_password, $userdata['password'])) {
		log_statistic("$apikey_kiri", 'LOGIN', $userid . '/FAIL');
		deinit_mysql();
		return_invalid_credentials("Password mismatch for $userid");
	}
	
	log_statistic("$apikey_kiri", 'LOGIN', $userid . '/SUCCESS');
	
	// Create session id
	$sessionid = generate_sessionid();
	mysqli_query($global_mysqli_link, "INSERT INTO sessions (sessionId, email) VALUES ('$sessionid', '$userid')") or
		die_nice('Failed to generate session: ' . mysqli_error($global_mysqli_link), true);

	// Construct privilege lists
	$privileges = '';
	if ($userdata['privilegeRoute'] != 0) {
		$privileges .= ",$proto_privilege_route";
	}
	if ($userdata['privilegeApiUsage'] != 0) {
		$privileges .= ",$proto_privilege_apiUsage";
	}
	if (strlen($privileges) > 0) {
		$privileges = substr($privileges, 1);
	}
	
	// Construct json.
	$json = array(
			$proto_status => $proto_status_ok,
			$proto_sessionid => $sessionid,
			$proto_privileges => $privileges
	);
	
	deinit_mysql();
	print(json_encode($json));
} elseif ($mode == $proto_mode_logout) {
	$sessionid = addslashes(retrieve_from_post($proto_sessionid));

	// Remove the session information
	$result = mysqli_query($global_mysqli_link, "DELETE FROM sessions WHERE sessionId='$sessionid'") or
		die_nice('Failed to logout sessionid $sessionid: ' . mysqli_error($global_mysqli_link), true);
	deinit_mysql();
	well_done();	
} elseif ($mode == $proto_mode_add_track) {
	check_privilege($privilege_route); 
	$trackid = addslashes(retrieve_from_post($proto_trackid));
	$trackname = addslashes(retrieve_from_post($proto_trackname));
	$tracktype = addslashes(retrieve_from_post($proto_tracktype));
	$penalty = addslashes(retrieve_from_post($proto_penalty));
	$internalinfo = addslashes(retrieve_from_post($proto_internalinfo, false)) or $internalinfo = '';
	
	// Check if the id is already existed
	$result = mysqli_query($global_mysqli_link, "SELECT trackId FROM tracks WHERE trackId='$trackid'") or
		die_nice('Failed to check trackid existence: ' . mysqli_error($global_mysqli_link), true);
	if (mysqli_num_rows($result) == 0) {
		mysqli_query($global_mysqli_link, "INSERT INTO tracks (trackId, trackTypeId, trackName, penalty, internalInfo) VALUES ('$trackid','$tracktype','$trackname','$penalty','$internalinfo')") or
			die_nice('Failed to add a new track: ' . mysqli_error($global_mysqli_link), true);
		update_trackversion();
	} else {
		die_nice("The trackId '$trackid' already existed.", true);
	}
	deinit_mysql();
	well_done();
} elseif ($mode == $proto_mode_update_track) {
	check_privilege($privilege_route);
	$trackid = addslashes(retrieve_from_post($proto_trackid));
	$newtrackid = addslashes(retrieve_from_post($proto_new_trackid));
	$tracktype = addslashes(retrieve_from_post($proto_tracktype));
	$trackname = addslashes(retrieve_from_post($proto_trackname));
	$internalinfo = addslashes(retrieve_from_post($proto_internalinfo, false)) or $internalinfo = '';
	$pathloop = retrieve_from_post($proto_pathloop) == 'true' ? 1 : 0;
	$penalty = addslashes(retrieve_from_post($proto_penalty));
	$transfernodes = retrieve_from_post($proto_transfernodes, false);
	
	// When changed, check if the id is already existed
	if ($newtrackid != $trackid) {
		$result = mysqli_query($global_mysqli_link, "SELECT trackId FROM tracks WHERE trackId='$newtrackid'") or
			die_nice('Failed to check trackid existence: ' . mysqli_error($global_mysqli_link), true);
		if (mysqli_num_rows($result) != 0) {
			die_nice("The new trackId '$newtrackid' already existed.", true);
		}
	}
	mysqli_query($global_mysqli_link, "UPDATE tracks SET trackTypeId='$tracktype', trackId='$newtrackid', trackName='$trackname', internalInfo='$internalinfo', pathloop='$pathloop', penalty='$penalty' WHERE trackId='$trackid'") or
		die_nice('Failed to update the track: ' . mysqli_error($global_mysqli_link));
	if (!is_null($transfernodes)) {
		$transfernodes = addslashes($transfernodes);
		mysqli_query($global_mysqli_link, "UPDATE tracks SET transferNodes='$transfernodes'WHERE trackId='$trackid'") or
			die_nice('Failed to update the track: ' . mysqli_error($global_mysqli_link));
	}
	update_trackversion();
	deinit_mysql();
	well_done();
} elseif ($mode == $proto_mode_list_tracks) {
	check_privilege($privilege_route);
	// Retrieve track list from database
	$result = mysqli_query($global_mysqli_link, 'SELECT trackTypeId, trackId, trackName FROM tracks ORDER BY trackTypeId, trackId') or
		die('Cannot retrieve the track names from database');
	$track_list = array();	
	while ($row = mysqli_fetch_row($result)) {
		$track_list[] = array($row[1], htmlspecialchars($row[0] . '/' . $row[2]));
	}
	// Retrieve track types list result from database
	$result = mysqli_query($global_mysqli_link, 'SELECT trackTypeId, name FROM tracktypes ORDER BY trackTypeId') or
		die_nice('Cannot retrieve the track types from database');
	$tracktype_list = array();
	while ($row = mysqli_fetch_row($result)) {
		$tracktype_list[] = array($row[0], htmlspecialchars($row[1]));
	}
	
	// Construct json.
	$json = array(
		$proto_status => $proto_status_ok,
		$proto_trackslist => $track_list,
		$proto_tracktypeslist => $tracktype_list
	);
	
	deinit_mysql();
	print(json_encode($json));
} elseif ($mode == $proto_mode_getdetails_track) {
	check_privilege($privilege_route);
	$trackid = addslashes(retrieve_from_post($proto_trackid));

	// Retrieve result from database and construct in XML format
	$result = mysqli_query($global_mysqli_link, "SELECT trackTypeId, trackName, internalInfo, AsText(geodata), pathloop, penalty, transferNodes FROM tracks WHERE trackId='$trackid'") or
		die_nice("Can't retrieve the track details from database: " . mysqli_error($global_mysqli_link), true);
	$i = 0;
	$row = mysqli_fetch_row($result);
	if ($row == FALSE) {
		die_nice("Can't find track information for '$trackid'", true);
	}
	$geodata = lineStringToLatLngArray($row[3]);
	// Construct json.
	$json = array(
		$proto_status => $proto_status_ok,
		$proto_trackid => $trackid,
		$proto_tracktype => $row[0],
		$proto_trackname => $row[1],
		$proto_internalinfo => $row[2],
		$proto_geodata => $geodata,
		$proto_pathloop => ($row[4] > 0 ? true : false),
		$proto_penalty => doubleval($row[5]),
		$proto_transfernodes => is_null($row[6]) ? array('0-' . (count($geodata) - 1)) : split(',', $row[6]), 
	);
	
	deinit_mysql();
	print(json_encode($json));
} elseif ($mode == $proto_mode_cleargeodata) {
	check_privilege($privilege_route);
	$trackid = addslashes(retrieve_from_post($proto_trackid));
	
	mysqli_query($global_mysqli_link, "UPDATE tracks SET geodata=NULL, transferNodes=NULL WHERE trackId='$trackid'") or
		die_nice('Failed to clear the geodata: ' . mysqli_error($global_mysqli_link), true);
	
	deinit_mysql();
	well_done();
} elseif ($mode == $proto_mode_importkml) {
	check_privilege($privilege_route);
	$trackid = addslashes(retrieve_from_post($proto_trackid));
	// Import KML file into a geodata in database
	if ($_FILES[$proto_uploadedfile]['error'] != UPLOAD_ERR_OK) {
		die_nice("Server script is unable to retrieve the file, with PHP's UPLOAD_ERR_xxx code: " . $_FILES[$proto_uploadedfile]['error'], true);
	}
	if ($_FILES[$proto_uploadedfile]['size'] > $max_filesize) {
		die_nice("Uploaded file size is greater than maximum size allowed ($max_filesize)", true);
	}
	$file = fopen($_FILES[$proto_uploadedfile]['tmp_name'], "r") or die_nice('Unable to open uploaded file', true);
	$haystack = '';
	while ($line = fgets($file)) {
		$haystack .= trim($line);
	}
	$num_matches = preg_match_all("/<LineString>.*<coordinates>(.*)<\/coordinates>.*<\/LineString>/i", $haystack, $matches, PREG_PATTERN_ORDER);
	if ($num_matches != 1) {
		die_nice("The KML file must contain exactly one <coordinate> tag inside one <LineString> tag. But I found $num_matches occurences", true);
	}
	fclose($file);
	
	// Start constructing output
	$output = 'LINESTRING(';
	$points = preg_split('/\s+/', $matches[1][0]);
	for ($i = 0, $size = sizeof($points); $i < $size; $i++) {
		list($x, $y, $z) = preg_split('/\s*,\s*/', $points[$i]);
		if ($i > 0) {
			$output .= ',';
		}
		$output .= "$x $y";
	}
	$output .= ')';
	mysqli_query($global_mysqli_link, "UPDATE tracks SET geodata=GeomFromText('$output'), transferNodes=NULL WHERE trackId='$trackid'") or
		die_nice("Error updating the goedata: " . mysqli_error($global_mysqli_link), true);
	update_trackversion();
	deinit_mysql();
	well_done();
} elseif ($mode == $proto_mode_delete_track) {
	check_privilege($privilege_route);
	$trackid = addslashes(retrieve_from_post($proto_trackid));
	
	init_mysql();
	
	// Check if the id is already existed
	mysqli_query($global_mysqli_link, "DELETE FROM tracks WHERE trackId='$trackid'") or
		die_nice('Failed to delete track $trackid: ' . mysqli_error($global_mysqli_link), true);
	if (mysqli_affected_rows($global_mysqli_link) == 0) {
		die_nice("The track $trackid was not found in the database", true);
	}
	update_trackversion();
	deinit_mysql();
	well_done();	
} elseif ($mode == $proto_mode_list_apikeys) {
	check_privilege($privilege_apiUsage);
	// Retrieve api key list from database
	$result = mysqli_query($global_mysqli_link, "SELECT verifier, domainFilter, description FROM apikeys WHERE email='$active_userid' ORDER BY verifier") or
		die_nice('Cannot retrieve the API keys list from database: ' . mysqli_error($global_mysqli_link));
	$apikey_list = array();	
	while ($row = mysqli_fetch_row($result)) {
		$apikey_list[] = array($row[0], $row[1], $row[2]);
	}
	
	// Construct json.
	$json = array(
		$proto_status => $proto_status_ok,
		$proto_apikeys_list => $apikey_list,
	);
	
	deinit_mysql();
	print(json_encode($json));
} elseif ($mode == $proto_mode_add_apikey) {
	check_privilege($privilege_apiUsage);
	$domainfilter = addslashes(retrieve_from_post($proto_domainfilter));
	$description = addslashes(retrieve_from_post($proto_description));
	$apikey = generate_apikey();
	
	// Retrieve api key list from database
	$result = mysqli_query($global_mysqli_link, "INSERT INTO apikeys(verifier, email, domainFilter, description) VALUES('$apikey', '$active_userid', '$domainfilter', '$description')") or
		die_nice('Cannot insert a new api key: ' . mysqli_error($global_mysqli_link));

	log_statistic("$apikey_kiri", 'ADDAPIKEY', $userid . $apikey);
	
	// Construct json.
	$json = array(
			$proto_status => $proto_status_ok,
			$proto_verifier => $apikey,
	);
	
	deinit_mysql();
	print(json_encode($json));
} elseif ($mode == $proto_mode_update_apikey) {
	check_privilege($privilege_apiUsage);
	$apikey = addslashes(retrieve_from_post($proto_verifier));
	$domainfilter = addslashes(retrieve_from_post($proto_domainfilter));
	$description = addslashes(retrieve_from_post($proto_description));
	// Ensure that this user has access to the apikey
	$result = mysqli_query($global_mysqli_link, "SELECT email FROM apikeys WHERE verifier='apikey'") or
		die_nice('Cannot check API key owner: ' . mysqli_error($global_mysqli_link));
	while ($row = mysqli_fetch_row($result)) {
		if ($row[0] != $active_userid) {
			die_nice("User $active_userid does not have privilege to update API Key $apikey");
		}
	}
	mysqli_query($global_mysqli_link, "UPDATE apikeys SET domainFilter='$domainfilter', description='$description' WHERE verifier='$apikey'") or
		die_nice('Failed to update API Key: ' . mysqli_error($global_mysqli_link));
	
	deinit_mysql();
	well_done();
} elseif ($mode == $proto_mode_register) {
	$email = addslashes(retrieve_from_post($proto_userid));
	$fullname = addslashes(retrieve_from_post($proto_fullname));
	$company = addslashes(retrieve_from_post($proto_company));

	// Check if the email has already been registered.
	$result = mysqli_query($global_mysqli_link, "SELECT email FROM users WHERE email='$email'") or
		die_nice('Cannot check user id existence: ' . mysqli_error($global_mysqli_link));
	if (mysqli_num_rows($result) > 0) {
		die_nice("Ooops! Email $email has already registered. Please check your mailbox or contact hello@kiri.travel");
	}

	// Generate and send password
	$password = generate_password();
	$hasher = new PasswordHash($passwordhash_cost_log2, $passwordhash_portable);
	$passwordHash = $hasher->HashPassword($password); 
	mysqli_query($global_mysqli_link, "INSERT INTO users(email, password, privilegeApiUsage, fullName, company) VALUES('$email', '$passwordHash', 1, '$fullname', '$company')") or
		die_nice('Cannot add new user $email: ' . mysqli_error($global_mysqli_link));	
	sendPassword($email, $password, $fullname);

	log_statistic("$apikey_kiri", 'REGISTER', "$email/$fullname/$company");
	
	deinit_mysql();
	well_done();
} elseif ($mode == $proto_mode_getprofile) {
		$email = $active_userid;
	
		$result = mysqli_query($global_mysqli_link, "SELECT fullName, company FROM users WHERE email='$email'") or
			die_nice('Cannot retrieve user details: ' . mysqli_error($global_mysqli_link));
		if ($row = mysqli_fetch_row($result)) {
			$fullname = $row[0];
			$company = $row[1];
		} else {
			die_nice("User $email not found in database.");
		} 
	
		deinit_mysql();
		// Construct json.
		$json = array(
				$proto_status => $proto_status_ok,
				$proto_fullname => $fullname,
				$proto_company => $company
		);
		
		print(json_encode($json));
} elseif ($mode == $proto_mode_update_profile) {
	$email = $active_userid;
	$password = addslashes(retrieve_from_post($proto_password, false));
	$fullname = addslashes(retrieve_from_post($proto_fullname));
	$company = addslashes(retrieve_from_post($proto_company));

	// Updates password if necessary
	if (!is_null($password) && $password != "") {		
		$hasher = new PasswordHash($passwordhash_cost_log2, $passwordhash_portable);
		$passwordHash = $hasher->HashPassword($password);
		mysqli_query($global_mysqli_link, "UPDATE users SET password='$passwordHash' WHERE email='$email'") or
			die_nice('Cannot update password for $email: ' . mysqli_error($global_mysqli_link));
	}
	mysqli_query($global_mysqli_link, "UPDATE users SET fullName='$fullname', company='$company' WHERE email='$email'") or
		die_nice('Cannot update profile for $email: ' . mysqli_error($global_mysqli_link));

	deinit_mysql();
	well_done();
} else {
	die_nice("Mode not understood: \"" . $mode . "\"", true);
}

/**
 * Return invalid credential error, close mysql connection, and exit.
 * @param string $logmessage the message to record in the log file.
 */
function return_invalid_credentials($logmessage) {
	global $proto_status, $proto_status_credentialfail, $errorlog_file, $global_mysqli_link;
	$ip_address = $_SERVER['REMOTE_ADDR'];
	log_error("Login failed (IP=$ip_address): $logmessage", '../' . $errorlog_file);
	$json = array(
		$proto_status => $proto_status_credentialfail);
	print(json_encode($json));
	mysqli_close($global_mysqli_link);
	exit(0);
}

/**
 * 
 * Simply checks the input parameter, when false do default action
 * to return "user does not have privilege"
 * @param boolean $privilege if false will return error
 */
function check_privilege($privilege) {
	if (!$privilege) {
		die_nice("User doesn't have enough privilege to perform the action.", true);
	}
}

/**
 * Scans a directory and remove files that have not been modified for max_age
 * @param string $path the path to the directory to clean 
 * @param int $max_age maximum age of the file in seconds
 * @return boolean true if okay, false if there's an error.
 */
function clean_temporary_files($path, $max_age) {
	$currenttime = time();
	if ($dirhandle = opendir($path)) {
		while (($file = readdir($dirhandle)) != FALSE) {
			$fullpath = "$path/$file";
			if (is_file($fullpath) && $currenttime - filemtime($fullpath) > $max_age) {
				if (!unlink($fullpath)) {
					return FALSE;
				}
			}
		}
		return TRUE;
	} else {
		return FALSE;
	}
}

?>
\end{lstlisting}

\begin{lstlisting}[language=PHP,basicstyle=\tiny,caption=utils.php,label={lst:utils.php}]
<?php
require_once 'constants.php';
require_once 'PHPMailer/PHPMailerAutoload.php';

/** Determines whether we should return error message or log it */
$global_hush_hush = false;

/** Stores the mysql connection for the whole script. */
$global_mysqli_link = null;

/**
 * Initialize mysql connection with the default configuration as specified in
 * constants.php. This method will also exit and print error message in case of problem.
 */
function init_mysql() {
	global $global_mysqli_link, $config_mysql_host, $config_mysql_username, $config_mysql_password, $config_mysql_database;
	$global_mysqli_link = mysqli_connect($config_mysql_host, $config_mysql_username, $config_mysql_password, $config_mysql_database) or
		die_nice("MySQL Connect error: " . mysqli_connect_error(), $header_printed);
}

/**
 * Close mysql connection, with additional error reporting.
 */
function deinit_mysql() {
	global $global_mysqli_link;
	mysqli_close($global_mysqli_link) or
		die_nice("Failure in closing mysql connection. Your transaction may have been processed.");
}

/**
 * Increment the track version by 1. Normally called after successful insert/delete/update
 */
function update_trackversion() {
	global $global_mysqli_link;
	mysqli_query($global_mysqli_link, "UPDATE properties SET propertyvalue=propertyvalue+1 WHERE propertyname='trackversion'") or
	die_nice("Error updating track version: " . mysqli_error($global_mysqli_link));
}

/**
* Increment the places version by 1. Normally called after successful insert/delete/update
*/
function update_placesversion() {
	global $global_mysqli_link;
	mysqli_query($global_mysqli_link, "UPDATE properties SET propertyvalue=propertyvalue+1 WHERE propertyname='placesversion'") or
	die_nice("Error updating places version: " . mysqli_error($global_mysqli_link));
}

/**
 * Log statistic entry to database
 * @param unknown $verifier the API key or host name
 * @param unknown $type the event type, one of $type_xxx in constants.
 * @param unknown $additional_info additional information about the event
 */
function log_statistic($verifier, $type, $additional_info) {
	global $global_mysqli_link;
	mysqli_query($global_mysqli_link, "INSERT INTO statistics (verifier, type, additionalInfo) VALUES ('$verifier','$type','$additional_info')") or
		die_nice("Error updating statistic: " . mysqli_error($global_mysqli_link));
}

/**
 * Return JSON error message and quit nicely
 * @param string $message The error message to return
 * @param boolean $mysqlclose set true to close existing mysql connection
 */
function die_nice($message, $mysqlclose=false) {
	global $locale, $global_mysqli_link;
	global $proto_status, $proto_status_error, $proto_message, $global_hush_hush;
	if ($global_hush_hush) {
		log_error($message);
		// In case we have a localization
		if ($locale == "id") {
			$message = 'Mohon ampun, ada masalah internal. Programmer amatir! Tapi jangan khawatir, ia akan ditegur.';
		} else {
			$message = 'Sorry, there\'s internal error. Bad coder, but he\'ll be notified!';
		}
	}
	$json = array(
		$proto_status => $proto_status_error,
		$proto_message => $message);
	print(json_encode($json));
	if ($mysqlclose) {
		mysqli_close($global_mysqli_link);
	}
	exit(0);
}

/**
 * Checks if the api key is valid, currently checks with domain
 * @param string $apikey the api key to check
 * @return booleean true if API key is valid, false if it is not registered, or a string containing other error messages  
 */
function check_apikey_validity($apikey)
{
	global $global_mysqli_link;
	
	// check apikey: is this api key exist in database?
	$apisqlquery = mysqli_query ( $global_mysqli_link, "SELECT verifier, ipFilter, domainFilter FROM apikeys WHERE
			verifier = '$apikey'" ) or die_nice( "failed to execute query on Apikey check." );
	
	// if it exist, it must be found 1 row (because apiKeyOrDomain are unique)
	if ($fields = mysqli_fetch_array ( $apisqlquery )) {
		// check for ip filter
		if ($_SERVER ['REMOTE_ADDR'] != $fields['ipFilter'] && $fields['ipFilter'] != NULL) {
			return "Usage of this api key is forbidden from IP Address " . $_SERVER ['REMOTE_ADDR'];
		}
		// check domain filter
		if (!domain_matches($_SERVER['HTTP_REFERER'], $fields['domainFilter'])) {
			return "Usage of this api key is forbidden from referer " . $_SERVER['HTTP_REFERER'];
		}
	} else {
		return false;
	}
	return true;
}

/**
 * Returns true if domain matches the filter
 * @param unknown $url the domain name
 * @param unknown $filter domain name, may contain * filter
 */
function domain_matches($url, $filter) {
	$filter = str_replace('.', '\.', $filter);
	$filter = str_replace('*', '.*', $filter);
	$domain = is_null($url) ? '' : parse_url($url, PHP_URL_HOST);
	return preg_match("/^$filter\$/", $domain) > 0;
}

/**
 * Return JSON status of OK, optionally with a message. Exits
 * the execution to ensure there's no additional outputs. 
 * @param string $message Optional message to be passed
 */
function well_done($message = null) {
	global $proto_status, $proto_status_ok, $proto_message;
	$json = array(
		$proto_status => $proto_status_ok,
	);
	if ($message != null) {
		$json[$proto_message] = $message;
	}
	print(json_encode($json));
	exit(0);
}

/**
 * Perform initializations on the PHP script
 */
function start_working() {
	header('Content-Type: application/json');
	header('Cache-control: no-cache');
	header('Pragma: no-cache');
}

/**
 * Get a parameter from post method, or return an error if not available
 * @param string $param the parameter name from post or get
 * @param boolean $mandatory when true, script will return error if parameter is not found 
 */
function retrieve_from_post($param, $mandatory = true) {
	$value = is_null($_POST[$param]) ? $_GET[$param] : $_POST[$param];
	if ($mandatory && $value == null) {
		die_nice("Value of $param is expected but not found");
	}
	// TODO try urldecode it, but see the impact for mjnserve 
	return $value;
}

/**
 * Get a parameter from get method, or return an error if not available
 * @param string $param the parameter name from get
 * @param boolean $mandatory when true, script will return error if parameter is not found
 */
function retrieve_from_get($param, $mandatory = true) {
	$value = $_GET[$param];
	if ($mandatory && $value == null) {
		die_nice("Value of $param is expected but not found");
	}
	return $value;
}

/**
 * Log an error to the predefined file
 * @param int $messsage The error message
 * @param $errorlog_location the error file location if needed to change.
 */
function log_error($message, $errorlog_location = null) {
	global $errorlog_file, $global_hush_hush;
	if (is_null($errorlog_location)) {
		$errorlog_location = $errorlog_file;
	}
	$file = fopen($errorlog_location, "a");
	if ($file == NULL) {
		// Don't let be in infinite loop
		$global_hush_hush = false;
		die_nice("Internal fatal error. I couldn't tell the coder. Could you mail to pascalalfadian@live.com? Please...?");
	}
 	$time = strftime('%d-%b-%Y %H:%M:%S GMT', time());
 	$server = '';
 	foreach ($_SERVER as $key => $value) {
 		$server .= str_replace("\n", "\\n", "$key=>$value;");
 	}
 	$post = '';
 	foreach ($_GET as $key => $value) {
 		$post .= str_replace("\n", "\\n", "$key=>$value;");
 	}
	fwrite($file, "time=$time;message=$message;\$POST=$post\n");	
	fclose($file);
}

/**
 * Compute distance in kilometers, between two latlon points.
 * Taken from http://www.movable-type.co.uk/scripts/latlong.html
 * @param unknown_type $lat1 latitude of the 1st point
 * @param unknown_type $lon1 longitude of the 1st point
 * @param unknown_type $lat2 latitude of the 2nd point
 * @param unknown_type $lon2 longitude of the 2nd point
 */
function compute_distance($lat1, $lon1, $lat2, $lon2) {
	$earth_radius= 6371; // in kilometers
	$dLat = deg2rad($lat2-$lat1);
	$dLon = deg2rad($lon2-$lon1);
	$lat1 = deg2rad($lat1);
	$lat2 = deg2rad($lat2);
	
	$a = sin($dLat/2) * sin($dLat/2) + sin($dLon/2) * sin($dLon/2) * cos($lat1) * cos($lat2);
	$c = 2 * atan2(sqrt($a), sqrt(1-$a));
	return $earth_radius * $c;
}

/**
 * Generates a random session id.
 * @return string the session id generated
 */
function generate_sessionid() {
	return generate_random("abcdefghiklmnopqrstuvwxyz0123456789", 16);
}

function generate_apikey() {
	return generate_random("01234456789ABCDEF", 16);
}

function generate_password() {
	return generate_random("abcdefghiklmnopqrstuvwxyz0123456789", 8);
}

/**
 * Generates a random string
 * @param string $chars available characters
 * @param int $length size of the string
 * @return string the generated string
 */
function generate_random($chars, $length) {
	$chars_size = strlen($chars);
	$string = '';
	for ($i = 0; $i < $length; $i++) {
		$string .= $chars[rand(0, $chars_size)];
	}
	return $string;
}

/**
 * Converts SQL's LINESTRING() format into array of LatLng
 * @param string $lineString
 * @return array of "lat,lng"
 */
function lineStringToLatLngArray($lineString) {
	if (is_null($lineString)) {
		return null;
	}
	$lineString = preg_replace('/LINESTRING\(([^)]+)\)/', '$1', $lineString);
	$lnglatArray = split(',', $lineString);
	$returnValue = array();
	foreach ($lnglatArray as $lnglat) {
		list($lng,$lat) = split(' ', $lnglat);
		$returnValue[] = sprintf("%.$latlon_precision" . "f,%.$latlon_precision" . "f", $lat, $lng);
	}
	return $returnValue;
}

/**
 * Checks cache if there is a value stored with a given key
 * @param unknown $type cache type
 * @param unknown $key the cache key
 * @return the cache value, or null if cache miss
 */
function get_from_cache($type, $key) {
	global $global_mysqli_link;
	$result = mysqli_query($global_mysqli_link, "SELECT cacheValue FROM cache WHERE type='$type' AND cacheKey='$key'") or
		die_nice("Unable to retrieve from cache: " . mysqli_error($global_mysqli_link));
	if ($row = mysqli_fetch_row($result)) {
		return $row[0];
	} else {
		return null;
	}
}

/**
 * Put into cache, log warning if duplicate.
 * @param unknown $type the cache type
 * @param unknown $key the cache key
 * @param unknown $value cache value
 */
function put_to_cache($type, $key, $value) {
	global $global_mysqli_link;
	$value = mysqli_real_escape_string($global_mysqli_link, $value);
	$result = mysqli_query($global_mysqli_link, "INSERT INTO cache(type, cacheKey, cacheValue) VALUES('$type', '$key','$value')") or
		log_error("Warning: Can't store cache of $type/$key($value) " . mysqli_error($global_mysqli_link));
}

/**
 * Send password to recipient
 * @param unknown $email the recipient email
 * @param unknown $password password
 * @param unknown $fullname Full name of the recipient
 * @param unknown $debug_level 0 to 2 for more debug options
 */
function sendPassword($email, $password, $fullname, $debug_level = 0) {
	date_default_timezone_set ( 'Asia/Jakarta' );
	$mail = new PHPMailer ();
	$mail->isSMTP ();
	$mail->SMTPDebug = $debug_level;
	$mail->Host = "smtp-mail.outlook.com";
	$mail->Port = 587;
	$mail->SMTPAuth = true;
	$mail->SMTPSecure = 'tls';
	$mail->Username = 'hello@kiri.travel';
	$mail->Password = "xxxxxxxx";
	$mail->setFrom ( 'hello@kiri.travel', 'Project KIRI' );
	$mail->addAddress ( $email, $fullname );
	$mail->Subject = 'KIRI API Registration';
	$mail->msgHTML ( "<p>Hello $fullname,</p>" . "<p>Thank you for becoming KIRI Friends. Please find below your<br/>" . "initial password (8 characters of alphanumerics): <pre>$password</pre><br/>" . "Please login to our site and change your password immediately.</p>" . "<p>Sincerely yours,<br/>" . "Pascal & Budyanto</p>" );
	$mail->AltBody = "Hello $fullname,\n\n" . "Thank you for becoming KIRI Friends. Please find below your\n" . "initial password (8 characters of alphanumerics): $password\n" . "Please login to our site and change your password immediately.\n\n" . "Sincerely yours,\n" . "Pascal & Budyanto\n";

	// send the message, check for errors
	if (!$mail->send ()) {
		die_nice('Email error: ' . $mail->ErrorInfo);
	}
}

/**
 * Detect whether it is a mobile browser or not. Taken from http://detectmobilebrowsers.com/
 * @return boolean true if a mobile browser, false otherwise
 */
function isMobileBrowser() {
	$useragent=$_SERVER['HTTP_USER_AGENT'];
	return preg_match('/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i',$useragent)||preg_match('/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i',substr($useragent,0,4));
}

/**
 * Validates the passed locale, allowing only valid ones.
 * @param string $locale the locale to validate
 * @return the validated locale, or default to english if invalid
 */
function validateLocale($locale) {
	global $proto_locale, $proto_locale_english, $proto_locale_indonesia;
	switch ($locale) {
		case $proto_locale_indonesia:
			return $locale;
		default:
			return $proto_locale_english;
	}
}

/**
 * Validates the passed region, allowing only valid ones.
 * @param string $region the region to validate
 * @return the validated region, or default to Bandung if invalid
 */
function validateRegion($region) {
	global $proto_region, $proto_region_bandung, $regioninfos;
	if (isset($regioninfos[$region])) {
		return $region;
	} else {
		return $proto_region_bandung;
	}
}

/**
 * Checks if a string starts with something
 * @param string $haystack the string to see
 * @param string $needle the prefix to check
 * @return boolean true if haystack starts with needle, false otherwise.
 */
function startsWith($haystack, $needle) {
	// search backwards starting from haystack length characters from the end
	return $needle === "" || strrpos($haystack, $needle, -strlen($haystack)) !== FALSE;
}
?>
\end{lstlisting}

\begin{lstlisting}[language=PHP,basicstyle=\tiny,caption=constants.php,label={lst:constants.php}]
<?php
	// Global debugging configuration
	error_reporting(E_ERROR | E_COMPILE_ERROR | E_COMPILE_WARNING);
	/** experimental flag. */
	$enable_experimental = false;
	
	/** hostname for mysql server */
	$config_mysql_host = 'localhost';
	/** username for mysql account */
	$config_mysql_username = 'tirtayasa';   
	/** password for the mysql account */
	$config_mysql_password = 'tirtayasa';
	/** database name that stores the tables */
	$config_mysql_database = 'tirtayasa';

	/** API key for main website. */
	$apikey_kiri = 'E5D9904F0A8B4F99';

	// Cache types and expiry
	$cache_geocoding = 'geocoding';
	$cache_expiry_geocoding_mysql = '6 MONTH';
	$cache_searchplace = 'searchplace';
	$cache_expiry_searchplace_mysql = '1 MONTH';
	
	/** Cookie expiry time. */
	$cookie_expiry = 3600 * 24 * 365;
		
	/** MySQL interval for session expiry. */
	$session_expiry_interval_mysql = '6 HOUR';
	/** Unix time interval for session expiry (seconds). */
	$session_expiry_interval_unix = 6 * 3600;
	/** Major customer's timezone in seconds, currently points to Bandung (GMT+7) */
	$timezone_offset = 7 * 60 * 60;
	
	/** Number of decimal digits for lat/lon. */ 
	$latlon_precision = 5;
	
	/** maximum uploaded file size */
	$max_filesize = 100 * 1024;
	
	/** The file to log error report. */
	$errorlog_file = "../log/error.log";
	/** The path for bukitjarian image uploads. */
	$fileupload_path = "./images/uploads";

	/** The menjangan server URL. */
	$menjangan_url = "http://newmenjangan.cloudapp.net:8000"; // Azure
	/** Timeout for waiting response from menjangan server, in seconds. */
	$menjangan_timeout = 3;
	/** Maximum size of response from external request acceptable by the script. */ 
	$maximum_http_response_size = 512000;
	
	/** Client id to be provided for 4sq. */
//	$foursq_client_id = 'EXFO1JBVNDPUI2N0WAAY0UIM5ILL5INQD13GFB4NSJ45KUQS';
	/** Client secret for 4sq. */
//	$foursq_client_secret = 'TYUQSXW2PPSXFOC1L0JKHOVHAKZWRKY5P0ECXMLPPHBMI13Y';
	/** URL for Places Search web service. */
//  pascal: switch to use foursquare
// 	$places_url = 'https://api.foursquare.com/v2/venues/search';
	$places_url = 'https://maps.googleapis.com/maps/api/place/nearbysearch/json';
	/** Maximum number of search result. */
	$search_maxresult = 10;
	/** API key for server side apps. */
	$gmaps_server_key = 'AIzaSyBa1bNBVkchvxSFd8U_Cn7HsHux6M-DIk4';
	/** URL for Google Maps' Reverse geocoding web service. */
	$gmaps_geocode_url = 'https://maps.googleapis.com/maps/api/geocode/json';
	
	$angkotwebid_url_prefix = 'https://angkot.web.id/go/route/';
	$angkotwebid_url_suffix = '?ref=kiri';
	
	$means_image_extension = '.png';
	
	/** Youtube link */
	$youtube_url_prefix = '//www.youtube.com/embed/';
	
	/** Average speed of walking, in km/h. */
	$speed_walk = 5;
	
	/** Maximum length of user id input. */
	$maximum_userid_length = 128;
	/** Maximum length of password input. */
	$maximum_password_length = 32;	
	/** The number of times hash will be done, final value will be 2^n. */
	$passwordhash_cost_log2 = 8;
	/** Allow hash function be portable (work in older system but less secured. */
	$passwordhash_portable = FALSE;
	/** Banner width in pixel. */
	$banner_width = 125;
	/** Banner height in pixel. */
	$banner_height = 50;
	
	/** GET Parametedr for youtube linking. */
	$param_youtube = 'yt';
	
	// CicaheumLedeng protocol constants
	$proto_address = 'address';
	$proto_apikey = 'apikey';
	$proto_apikeys_list = 'apikeyslist';
	$proto_attributions = 'attributions';	
	$proto_company = 'company';
	$proto_description = 'description';
	$proto_domainfilter = 'domainfilter';
	$proto_errorcode = 'errorcode';
	$proto_filename = 'filename';
	$proto_fqcategoryid = 'fqcategoryid';
	$proto_fullname = 'fullname';
	$proto_geodata = 'geodata';
	$proto_internalinfo = 'internalinfo';
	$proto_locale = 'locale';
	$proto_locale_indonesia = 'id';
	$proto_locale_english = 'en';
	$proto_location = 'location';
	$proto_message = 'message';
	$proto_mode = 'mode';
	$proto_mode_add_track = 'addtrack';
	$proto_mode_add_apikey = 'addapikey';
	$proto_mode_cleargeodata = 'cleargeodata';
	$proto_mode_delete_place = 'deleteplace';
	$proto_mode_delete_track = 'deletetrack';
	$proto_mode_findroute = 'findroute';
	$proto_mode_getdetails_track = 'getdetailstrack';
	$proto_mode_getprofile = 'getprofile';
	$proto_mode_importkml = 'importkml';
	$proto_mode_list_apikeys = 'listapikeys';
	$proto_mode_list_places = 'listplaces';
	$proto_mode_list_tracks = 'listtracks';
	$proto_mode_login = 'login';
	$proto_mode_logout = 'logout';
	$proto_mode_register = 'register';
	$proto_mode_reporterror = 'reporterror';
	$proto_mode_search = 'searchplace';
	$proto_mode_update_apikey = 'updateapikey';
	$proto_mode_update_profile = 'updateprofile';
	$proto_mode_update_track = 'updatetrack';
	$proto_mode_nearbytransports = 'nearbytransports';
	$proto_nearbytransports = 'nearbytransports';
	$proto_new_trackid = 'newtrackid';
	$proto_orderid = 'orderid';
	$proto_password = 'password';
	$proto_pathloop = 'loop';
	$proto_penalty = 'penalty';
	$proto_phonenumber = 'phonenumber';
	$proto_placename = 'placename';
	$proto_placeslistresult = 'placeslistresult';
	$proto_presentation = 'presentation';
	$proto_presentation_desktop = 'desktop';
	$proto_presentation_mobile = 'mobile';
	$proto_privilege_apiUsage = 'apiusage';
	$proto_privilege_route = 'route';
	$proto_privileges = 'privileges';
	$proto_querystring = 'querystring';
	$proto_radius = 'radius';
	$proto_rating = 'rating';
	$proto_region = 'region';
	$proto_region_bandung = 'bdo';
	$proto_region_jakarta = 'cgk';
	$proto_region_surabaya = 'sub';
	$proto_region_malang = 'mlg';
	$proto_routefinish = 'finish';
	$proto_routestart = 'start';
	$proto_routingresult = 'routingresult';
	$proto_routingresults = 'routingresults';
	$proto_search_querystring = 'querystring';
	$proto_search_result = 'searchresult';
	$proto_sessionid = 'sessionid';
	$proto_status = 'status';
	$proto_status_credentialfail = 'credentialfail';
	$proto_status_error = 'error';
	$proto_status_ok = 'ok';
	$proto_status_sessionexpired = 'sessionexpired';
	$proto_steps = 'steps';
	$proto_time = 'time';
	$proto_trackid = 'trackid';
	$proto_trackname = 'trackname';
	$proto_tracktype = 'tracktype';
	$proto_trackslist = 'trackslist';
	$proto_tracktypeslist = 'tracktypeslist';
	$proto_transfernodes = 'transfernodes';
	$proto_traveltime = 'traveltime';
	$proto_updateprofile = 'updateprofile';
	$proto_uploadedfile = 'uploadedfile';
	$proto_url = 'url';
	$proto_userid = 'userid';
	$proto_venuedetailsref = 'venuedetailsref';
	$proto_venuephotoref = 'venuephotoref';
	$proto_venueid = 'venueid';
	$proto_venues = 'venues';
	$proto_verifier = 'verifier';
	$proto_version = 'version';
	$proto_width = 'width';
	// KalapaDago protocol constants
	$protokd_point_finish = 'finish';
	$protokd_point_start = 'start';
	$protokd_result_none = 'none';
	$protokd_transitmode_walk = 'walk';
	$protokd_maximumwalk = 'mw';
	$protokd_walkingmultiplier = 'wm';
	$protokd_penaltytransfer = 'pt';
	
	/** Different parameters for routing alternatives. */
	$alternatives = array(
			/* Normal */
			array(
					$protokd_maximumwalk => 0.75,
					$protokd_walkingmultiplier => 1,
					$protokd_penaltytransfer => 0.15
			),
			/* Prefer walking */
			array(
					$protokd_maximumwalk => 1,
					$protokd_walkingmultiplier => 0.75,
					$protokd_penaltytransfer => 0.15
			),
			/* Avoid transfers */
			array(
					$protokd_maximumwalk => 0.75,
					$protokd_walkingmultiplier => 1,
					$protokd_penaltytransfer => 0.45
			),
	);

	/** Different parameters for different regions. */
	$regioninfos = array(
		$proto_region_bandung => array(
			'lat' => -6.91474,
			'lon' => 107.60981,
			'radius' => 17000,
			'zoom' => 12,
			'searchplace_regex' => ', *(bandung|bdg)$',
			'name' => 'Bandung'
		),
		$proto_region_jakarta => array(
			'lat' => -6.21154,
			'lon' => 106.84517,
			'radius' => 15000,
			'zoom' => 11,
			'searchplace_regex' => ', *(jakarta|jkt)$',
			'name' => 'Jakarta'
		),
		$proto_region_surabaya => array(
			'lat' => -7.27421,
			'lon' => 112.71908,
			'radius' => 15000,
			'zoom' => 12,
			'searchplace_regex' => ', *(surabaya|sby)$',
			'name' => 'Surabaya'
		),
		$proto_region_malang => array(
			'lat' => -7.9812985,
			'lon' => 112.6319264,
			'radius' => 15000,
			'zoom' => 13,
			'searchplace_regex' => ', *(malang|mlg)$',
			'name' => 'Malang'				
		)
	);

?>
\end{lstlisting}
